
<!DOCTYPE html>
<html>
<head>
<style type="text/css">
.knitr .inline {
  background-color: #f7f7f7;
  border:solid 1px #B0B0B0;
}
.error {
	font-weight: bold;
	color: #FF0000;
}
.warning {
	font-weight: bold;
}
.message {
	font-style: italic;
}
.source, .output, .warning, .error, .message {
	padding: 0 1em;
  border:solid 1px #F7F7F7;
}
.source {
  background-color: #f5f5f5;
}
.rimage .left {
  text-align: left;
}
.rimage .right {
  text-align: right;
}
.rimage .center {
  text-align: center;
}
.hl.num {
  color: #AF0F91;
}
.hl.str {
  color: #317ECC;
}
.hl.com {
  color: #AD95AF;
  font-style: italic;
}
.hl.opt {
  color: #000000;
}
.hl.std {
  color: #585858;
}
.hl.kwa {
  color: #295F94;
  font-weight: bold;
}
.hl.kwb {
  color: #B05A65;
}
.hl.kwc {
  color: #55aa55;
}
.hl.kwd {
  color: #BC5A65;
  font-weight: bold;
}
</style>
  <script src="https://yihui.name/media/js/center-images.js"></script>
  <title></title>
</head>
<body>

  <p>This report is automatically generated with the R
    package <a href="https://yihui.name/knitr/"><strong>knitr</strong></a>
    (version <code class="knitr inline">1.20</code>)
    .</p>

<div class="chunk" id="auto-report"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl com">## Function that create the simulated dataset</span>

<span class="hl std">Dataset_creation</span><span class="hl kwb">=</span><span class="hl kwa">function</span><span class="hl std">(</span><span class="hl kwc">prop_type</span><span class="hl std">,</span><span class="hl kwc">cst_var</span><span class="hl std">,</span><span class="hl kwc">mu</span><span class="hl std">=</span><span class="hl num">3</span><span class="hl std">,</span><span class="hl kwc">cst_sampling</span><span class="hl std">=</span><span class="hl num">1e3</span><span class="hl std">,</span><span class="hl kwc">crossOverReports</span><span class="hl std">=crossOverReports,</span><span class="hl kwc">indic</span><span class="hl std">=indic,</span><span class="hl kwc">conta_prop</span><span class="hl std">=conta_prop,</span><span class="hl kwc">loop</span><span class="hl std">=</span><span class="hl num">FALSE</span><span class="hl std">){</span>

  <span class="hl com"># * prop_type: proportion for each type of IS (GMBKT,GM,T) to define an homogeneous or heterogeneous population.</span>
  <span class="hl com"># * cst_var, mu are simulation constants : see Step 2 in paragraph 9.2 of Supplementary methods.</span>
  <span class="hl com"># * cst_sampling is the % of total cells to select to simulate the random sparse sampling.</span>
  <span class="hl com"># * crossOverReports,indic and conta_prop are real values giving the cells proportion, the contamination matrix etc.</span>
  <span class="hl com"># * loop is a boolean value. By default the value is FALSE to use a seed for reproductibility.</span>
  <span class="hl com">#   In the case of the MONTE-CARLO loop the value will be TRUE.</span>

  <span class="hl com">####################################</span>
  <span class="hl com">####  Whole blood IS population #### </span>
  <span class="hl com">####################################</span>

  <span class="hl com">#Fix the result for reproductibility </span>
  <span class="hl kwa">if</span><span class="hl std">(loop</span> <span class="hl opt">==</span> <span class="hl num">FALSE</span><span class="hl std">) {</span>
    <span class="hl kwd">set.seed</span><span class="hl std">(</span><span class="hl num">123</span><span class="hl std">)</span>
    <span class="hl kwd">print</span><span class="hl std">(</span><span class="hl kwd">paste</span><span class="hl std">(</span><span class="hl kwd">c</span><span class="hl std">(</span><span class="hl str">&quot;cst_variance :&quot;</span><span class="hl std">,cst_var,</span><span class="hl str">'||'</span><span class="hl std">,</span>
                  <span class="hl str">&quot;proportion of GMBKT IS:&quot;</span><span class="hl std">,prop_type[</span><span class="hl num">1</span><span class="hl std">],</span><span class="hl str">'||'</span><span class="hl std">,</span>
                  <span class="hl str">&quot;proportion of GM IS:&quot;</span><span class="hl std">,prop_type[</span><span class="hl num">2</span><span class="hl std">],</span><span class="hl str">'||'</span><span class="hl std">,</span>
                  <span class="hl str">&quot;proportion of T IS:&quot;</span><span class="hl std">,prop_type[</span><span class="hl num">3</span><span class="hl std">],</span><span class="hl str">'||'</span><span class="hl std">,</span>
                  <span class="hl str">&quot;cst for sampling :&quot;</span><span class="hl std">,cst_sampling),</span><span class="hl kwc">collapse</span> <span class="hl std">=</span> <span class="hl str">&quot; &quot;</span><span class="hl std">))}</span>

  <span class="hl com">#Nb of IS to generate (see Step 1 in paragraph 9.2 of Supplementary methods)</span>
  <span class="hl std">pop_size</span><span class="hl kwb">=</span> <span class="hl std">indic</span><span class="hl opt">$</span><span class="hl std">Chao1</span>

  <span class="hl com">#Abundance parameters (see Step 2 in paragraph 9.2 of Supplementary methods)</span>
  <span class="hl std">mu_data</span><span class="hl kwb">=</span> <span class="hl std">indic</span><span class="hl opt">$</span><span class="hl std">mean_cells</span>
  <span class="hl std">v_data</span> <span class="hl kwb">=</span> <span class="hl std">indic</span><span class="hl opt">$</span><span class="hl std">var</span>
  <span class="hl std">cst_mean</span><span class="hl kwb">=</span> <span class="hl std">mu</span><span class="hl opt">*</span><span class="hl num">10</span><span class="hl opt">^</span><span class="hl num">3</span>
  <span class="hl std">mu_sim</span> <span class="hl kwb">=</span> <span class="hl std">mu_data</span> <span class="hl opt">*</span> <span class="hl std">cst_mean</span>
  <span class="hl std">v_sim</span> <span class="hl kwb">=</span> <span class="hl std">v_data</span> <span class="hl opt">*</span> <span class="hl std">cst_mean</span><span class="hl opt">^</span><span class="hl num">2</span> <span class="hl opt">*</span><span class="hl std">cst_var</span>

  <span class="hl com">## Calcul of a low_threshold to avoid missing cell type</span>
  <span class="hl std">low_threshold</span> <span class="hl kwb">=</span> <span class="hl num">1</span> <span class="hl opt">/</span> <span class="hl kwd">min</span><span class="hl std">(crossOverReports</span><span class="hl opt">$</span><span class="hl std">cellCount)</span>

  <span class="hl com">## Calcul of the second parameter of the rnegbin (theta)</span>

  <span class="hl com">#1) overdispersion</span>
  <span class="hl std">sur_dispersion</span> <span class="hl kwb">=</span> <span class="hl kwa">function</span><span class="hl std">(</span><span class="hl kwc">mu</span><span class="hl std">,</span> <span class="hl kwc">v</span> <span class="hl std">){</span>
    <span class="hl std">sur_dis</span> <span class="hl kwb">=</span> <span class="hl std">v</span><span class="hl opt">/</span><span class="hl std">mu</span> <span class="hl opt">-</span><span class="hl num">1</span>
    <span class="hl kwd">return</span><span class="hl std">(sur_dis)</span>
  <span class="hl std">}</span>
  <span class="hl std">surdis</span><span class="hl kwb">=</span><span class="hl kwd">sur_dispersion</span><span class="hl std">(mu_sim</span> <span class="hl opt">+</span> <span class="hl std">low_threshold,v_sim)</span>

  <span class="hl com">#2) theta</span>
  <span class="hl std">theta_from_mu_surdis</span> <span class="hl kwb">=</span> <span class="hl kwa">function</span><span class="hl std">(</span><span class="hl kwc">mu</span><span class="hl std">,</span><span class="hl kwc">surdis</span><span class="hl std">){</span>
    <span class="hl kwd">return</span><span class="hl std">(mu</span><span class="hl opt">/</span><span class="hl std">surdis)</span>
  <span class="hl std">}</span>
  <span class="hl std">theta</span><span class="hl kwb">=</span><span class="hl kwd">theta_from_mu_surdis</span><span class="hl std">(mu_sim,surdis)</span>

  <span class="hl com">#Get each cell proportion according the type (see Step 3 in paragraph 9.2 of Supplementary methods)</span>
  <span class="hl std">prob_cells</span><span class="hl kwb">=</span><span class="hl std">crossOverReports</span><span class="hl opt">$</span><span class="hl std">cellCount</span>
  <span class="hl std">type_cells</span><span class="hl kwb">=</span><span class="hl kwd">list</span><span class="hl std">()</span>
  <span class="hl std">type_cells[[</span><span class="hl str">'GMBKT'</span><span class="hl std">]]</span><span class="hl kwb">=</span><span class="hl num">1</span><span class="hl opt">:</span><span class="hl num">5</span>
  <span class="hl std">type_cells[[</span><span class="hl str">'GM'</span><span class="hl std">]]</span><span class="hl kwb">=</span><span class="hl num">2</span><span class="hl opt">:</span><span class="hl num">3</span>
  <span class="hl std">type_cells[[</span><span class="hl str">'T'</span><span class="hl std">]]</span><span class="hl kwb">=</span><span class="hl num">5</span>

  <span class="hl com"># ~ Step 1-2-3 : whole blood simulation ~</span>

  <span class="hl com">#Create a dataframe with a posid and a column 'gene' to match the real values format for the pipeline.</span>
  <span class="hl com">#IS_abund correspond to the simulated abundance obtained with the rnegbin function.</span>
  <span class="hl std">pop_df</span> <span class="hl kwb">=</span> <span class="hl kwd">tibble</span><span class="hl std">(</span><span class="hl kwc">posid</span> <span class="hl std">=</span> <span class="hl kwd">c</span><span class="hl std">(</span><span class="hl num">1</span><span class="hl opt">:</span><span class="hl std">pop_size) ,</span> <span class="hl kwc">gene</span> <span class="hl std">=</span> <span class="hl kwd">rep</span><span class="hl std">(</span><span class="hl num">NA</span><span class="hl std">,pop_size) ,</span> <span class="hl kwc">IS_abund</span> <span class="hl std">=</span> <span class="hl kwd">ceiling</span><span class="hl std">(low_threshold)</span> <span class="hl opt">+</span> <span class="hl kwd">rnegbin</span><span class="hl std">(</span><span class="hl kwc">n</span><span class="hl std">=pop_size,</span><span class="hl kwc">mu</span><span class="hl std">=mu_sim,</span><span class="hl kwc">theta</span><span class="hl std">=theta))</span>

  <span class="hl com">#Determine the type of IS (GMBKT-GM-T) randomly determined with the prop_type frequencies </span>
  <span class="hl std">types</span> <span class="hl kwb">=</span> <span class="hl kwd">sample</span><span class="hl std">(</span><span class="hl kwd">c</span><span class="hl std">(</span><span class="hl str">'GMBKT'</span><span class="hl std">,</span><span class="hl str">'GM'</span><span class="hl std">,</span><span class="hl str">'T'</span><span class="hl std">),</span><span class="hl kwc">size</span><span class="hl std">= pop_size ,</span> <span class="hl kwc">prob</span> <span class="hl std">= prop_type,</span> <span class="hl kwc">replace</span> <span class="hl std">= T)</span>

  <span class="hl com">#Regroup the data and create empty column to receive the cell type repartition</span>
  <span class="hl std">pop_df</span> <span class="hl kwb">=</span> <span class="hl kwd">mutate</span><span class="hl std">(pop_df ,</span> <span class="hl kwc">type</span> <span class="hl std">= types)</span>
  <span class="hl std">pop_df</span> <span class="hl kwb">=</span> <span class="hl kwd">mutate</span><span class="hl std">(pop_df ,</span> <span class="hl kwc">Bcells</span> <span class="hl std">=</span> <span class="hl str">'NA'</span><span class="hl std">,</span> <span class="hl kwc">Monocytes</span> <span class="hl std">=</span> <span class="hl str">'NA'</span><span class="hl std">,</span> <span class="hl kwc">Granulocytes</span> <span class="hl std">=</span> <span class="hl str">'NA'</span><span class="hl std">,</span> <span class="hl kwc">NKcells</span> <span class="hl std">=</span> <span class="hl str">'NA'</span><span class="hl std">,</span> <span class="hl kwc">Tcells</span><span class="hl std">=</span> <span class="hl str">'NA'</span><span class="hl std">)</span>

  <span class="hl com">#Cell type repartition for each IS</span>

  <span class="hl com">##loop &amp; filter on the IS type</span>
  <span class="hl kwa">for</span> <span class="hl std">(typ</span> <span class="hl kwa">in</span> <span class="hl kwd">unique</span><span class="hl std">(types)){</span>
    <span class="hl std">pop_df_filtered</span> <span class="hl kwb">=</span> <span class="hl kwd">filter</span><span class="hl std">(pop_df, type</span> <span class="hl opt">==</span> <span class="hl std">typ )</span>
    <span class="hl std">all_cells</span> <span class="hl kwb">=</span><span class="hl kwd">do.call</span><span class="hl std">(rbind,</span><span class="hl kwd">lapply</span><span class="hl std">(</span><span class="hl num">1</span><span class="hl opt">:</span><span class="hl kwd">nrow</span><span class="hl std">(pop_df_filtered),</span><span class="hl kwa">function</span><span class="hl std">(</span><span class="hl kwc">i</span><span class="hl std">){</span>

    <span class="hl com">##The total abundance is distributed with a multinomial function, according the prob_cells  </span>
    <span class="hl std">val_bycell</span> <span class="hl kwb">=</span> <span class="hl kwd">t</span><span class="hl std">(</span><span class="hl kwd">rmultinom</span><span class="hl std">(</span><span class="hl kwc">n</span><span class="hl std">=</span><span class="hl num">1</span><span class="hl std">,</span><span class="hl kwc">size</span><span class="hl std">=pop_df_filtered</span><span class="hl opt">$</span><span class="hl std">IS_abund[i],prob_cells))</span>

    <span class="hl com">#erase the cell not present in the type</span>
    <span class="hl std">num</span><span class="hl kwb">=</span><span class="hl std">type_cells[[typ]]</span>
    <span class="hl std">val_bycell[</span><span class="hl opt">-</span><span class="hl std">num]</span><span class="hl kwb">=</span><span class="hl num">0</span>
    <span class="hl std">val_bycell</span>
    <span class="hl std">}))</span>
    <span class="hl std">pop_df[pop_df</span><span class="hl opt">$</span><span class="hl std">type</span> <span class="hl opt">==</span> <span class="hl std">typ,cells]</span> <span class="hl kwb">=</span> <span class="hl std">all_cells</span>
  <span class="hl std">}</span>

  <span class="hl kwd">rm</span><span class="hl std">(pop_df_filtered)</span>
  <span class="hl kwd">rm</span><span class="hl std">(all_cells)</span>

  <span class="hl com">## The pop_df dataset represents the whole blood data.</span>
  <span class="hl com">## It is composed of a posid, a gene column, a total abundance (IS_abund), an IS type (GMBKT,GM or T) and an abundance for each cell type.</span>
  <span class="hl std">pop_df</span> <span class="hl kwb">=</span> <span class="hl kwd">mutate</span><span class="hl std">(pop_df ,</span> <span class="hl kwc">Bcells</span> <span class="hl std">=</span> <span class="hl kwd">as.numeric</span><span class="hl std">(Bcells),</span>
                  <span class="hl kwc">Monocytes</span> <span class="hl std">=</span><span class="hl kwd">as.numeric</span><span class="hl std">(Monocytes),</span>
                  <span class="hl kwc">Granulocytes</span> <span class="hl std">=</span><span class="hl kwd">as.numeric</span><span class="hl std">(Granulocytes),</span>
                  <span class="hl kwc">NKcells</span> <span class="hl std">=</span> <span class="hl kwd">as.numeric</span><span class="hl std">(NKcells),</span>
                  <span class="hl kwc">Tcells</span> <span class="hl std">=</span> <span class="hl kwd">as.numeric</span><span class="hl std">(Tcells))</span>


  <span class="hl com">#Calcul of differents indicators on this dataset.</span>
  <span class="hl std">indic_values</span><span class="hl kwb">=</span><span class="hl kwd">data.frame</span><span class="hl std">(</span><span class="hl kwc">NBofIS</span><span class="hl std">=</span><span class="hl kwd">nrow</span><span class="hl std">(pop_df),</span><span class="hl kwc">Mean</span><span class="hl std">=</span><span class="hl kwd">mean</span><span class="hl std">(</span><span class="hl kwd">rowSums</span><span class="hl std">(pop_df[cells])),</span><span class="hl kwc">Var</span><span class="hl std">=</span><span class="hl kwd">var</span><span class="hl std">(</span><span class="hl kwd">rowSums</span><span class="hl std">(pop_df[cells])))</span>
  <span class="hl std">prop</span><span class="hl kwb">=</span><span class="hl kwd">colSums</span><span class="hl std">(pop_df[,cells])</span><span class="hl opt">/</span><span class="hl kwd">sum</span><span class="hl std">(pop_df[,cells])</span>
  <span class="hl std">mean</span><span class="hl kwb">=</span><span class="hl kwd">c</span><span class="hl std">(indic</span><span class="hl opt">$</span><span class="hl std">mean_cells,indic_values</span><span class="hl opt">$</span><span class="hl std">Mean)</span>
  <span class="hl std">var</span><span class="hl kwb">=</span><span class="hl kwd">c</span><span class="hl std">(indic</span><span class="hl opt">$</span><span class="hl std">var,indic_values</span><span class="hl opt">$</span><span class="hl std">Var)</span>

  <span class="hl com">####################################</span>
  <span class="hl com">########  Errors modelling ######### </span>
  <span class="hl com">####################################</span>

  <span class="hl com">#We simulate the different errors introduced during the procedure (see Step 4 in paragraph 9.2 of Supplementary methods).</span>

  <span class="hl com">## **1) Random sparse sampling **</span>

  <span class="hl com">## Change the format of the data to work on each cell (long format) and</span>
  <span class="hl com">#  select only a fraction of the total cells to imitate the blood test effect (n_cells/cst_sampling).</span>
  <span class="hl std">data_B</span><span class="hl kwb">=</span><span class="hl std">pop_df</span>  <span class="hl opt">%&gt;%</span> <span class="hl std">dplyr</span><span class="hl opt">::</span><span class="hl kwd">select</span><span class="hl std">(posid,Bcells)</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">uncount</span><span class="hl std">(Bcells)</span>  <span class="hl opt">%&gt;%</span> <span class="hl kwd">mutate</span><span class="hl std">(</span><span class="hl kwc">celltype</span><span class="hl std">=</span><span class="hl str">'Bcells'</span><span class="hl std">)</span>
  <span class="hl std">n_cells</span> <span class="hl kwb">=</span> <span class="hl kwd">nrow</span><span class="hl std">(data_B)</span>
  <span class="hl std">data_B</span> <span class="hl kwb">=</span> <span class="hl std">data_B</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">sample_n</span><span class="hl std">(.,</span><span class="hl kwc">size</span><span class="hl std">=n_cells</span><span class="hl opt">/</span><span class="hl std">cst_sampling)</span>
  <span class="hl std">data_M</span><span class="hl kwb">=</span><span class="hl std">pop_df</span>  <span class="hl opt">%&gt;%</span> <span class="hl std">dplyr</span><span class="hl opt">::</span><span class="hl kwd">select</span><span class="hl std">(posid,Monocytes)</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">uncount</span><span class="hl std">(Monocytes)</span>  <span class="hl opt">%&gt;%</span> <span class="hl kwd">mutate</span><span class="hl std">(</span><span class="hl kwc">celltype</span><span class="hl std">=</span><span class="hl str">'Monocytes'</span><span class="hl std">)</span>
  <span class="hl std">n_cells</span> <span class="hl kwb">=</span> <span class="hl kwd">nrow</span><span class="hl std">(data_M)</span>
  <span class="hl std">data_M</span> <span class="hl kwb">=</span> <span class="hl std">data_M</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">sample_n</span><span class="hl std">(</span><span class="hl kwc">size</span><span class="hl std">=n_cells</span><span class="hl opt">/</span><span class="hl std">cst_sampling)</span>
  <span class="hl std">data_G</span><span class="hl kwb">=</span><span class="hl std">pop_df</span>  <span class="hl opt">%&gt;%</span> <span class="hl std">dplyr</span><span class="hl opt">::</span><span class="hl kwd">select</span><span class="hl std">(posid,Granulocytes)</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">uncount</span><span class="hl std">(Granulocytes)</span>  <span class="hl opt">%&gt;%</span> <span class="hl kwd">mutate</span><span class="hl std">(</span><span class="hl kwc">celltype</span><span class="hl std">=</span><span class="hl str">'Granulocytes'</span><span class="hl std">)</span>
  <span class="hl std">n_cells</span> <span class="hl kwb">=</span> <span class="hl kwd">nrow</span><span class="hl std">(data_G)</span>
  <span class="hl std">data_G</span> <span class="hl kwb">=</span> <span class="hl std">data_G</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">sample_n</span><span class="hl std">(</span><span class="hl kwc">size</span><span class="hl std">=n_cells</span><span class="hl opt">/</span><span class="hl std">cst_sampling)</span>
  <span class="hl std">data_K</span><span class="hl kwb">=</span><span class="hl std">pop_df</span>  <span class="hl opt">%&gt;%</span> <span class="hl std">dplyr</span><span class="hl opt">::</span><span class="hl kwd">select</span><span class="hl std">(posid,NKcells)</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">uncount</span><span class="hl std">(NKcells)</span>  <span class="hl opt">%&gt;%</span> <span class="hl kwd">mutate</span><span class="hl std">(</span><span class="hl kwc">celltype</span><span class="hl std">=</span><span class="hl str">'NKcells'</span><span class="hl std">)</span>
  <span class="hl std">n_cells</span> <span class="hl kwb">=</span> <span class="hl kwd">nrow</span><span class="hl std">(data_K)</span>
  <span class="hl std">data_K</span> <span class="hl kwb">=</span> <span class="hl std">data_K</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">sample_n</span><span class="hl std">(</span><span class="hl kwc">size</span><span class="hl std">=n_cells</span><span class="hl opt">/</span><span class="hl std">cst_sampling)</span>
  <span class="hl std">data_T</span><span class="hl kwb">=</span><span class="hl std">pop_df</span>  <span class="hl opt">%&gt;%</span> <span class="hl std">dplyr</span><span class="hl opt">::</span><span class="hl kwd">select</span><span class="hl std">(posid,Tcells)</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">uncount</span><span class="hl std">(Tcells)</span>  <span class="hl opt">%&gt;%</span> <span class="hl kwd">mutate</span><span class="hl std">(</span><span class="hl kwc">celltype</span><span class="hl std">=</span><span class="hl str">'Tcells'</span><span class="hl std">)</span>
  <span class="hl std">n_cells</span> <span class="hl kwb">=</span> <span class="hl kwd">nrow</span><span class="hl std">(data_T)</span>
  <span class="hl std">data_T</span> <span class="hl kwb">=</span> <span class="hl std">data_T</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">sample_n</span><span class="hl std">(</span><span class="hl kwc">size</span><span class="hl std">=n_cells</span><span class="hl opt">/</span><span class="hl std">cst_sampling)</span>

  <span class="hl std">bias1</span> <span class="hl kwb">=</span> <span class="hl kwd">bind_rows</span><span class="hl std">(data_B,data_M,data_G,data_K,data_T)</span>

  <span class="hl kwd">rm</span><span class="hl std">(data_B,data_M,data_G,data_K,data_T,n_cells)</span>

  <span class="hl com">#Calcul of differents indicators on this dataset.</span>
  <span class="hl std">is_val</span><span class="hl kwb">=</span><span class="hl std">bias1</span> <span class="hl opt">%&gt;%</span> <span class="hl std">dplyr</span><span class="hl opt">::</span><span class="hl kwd">select</span><span class="hl std">(celltype,posid)</span>  <span class="hl opt">%&gt;%</span> <span class="hl kwd">group_by</span><span class="hl std">(posid)</span> <span class="hl opt">%&gt;%</span> <span class="hl std">dplyr</span><span class="hl opt">::</span><span class="hl kwd">summarise</span><span class="hl std">(</span><span class="hl kwc">cellcount</span><span class="hl std">=</span><span class="hl kwd">n</span><span class="hl std">())</span>
  <span class="hl std">indic_values</span><span class="hl kwb">=</span><span class="hl kwd">data.frame</span><span class="hl std">(</span><span class="hl kwc">NBofIS</span><span class="hl std">=</span><span class="hl kwd">nrow</span><span class="hl std">(is_val),</span><span class="hl kwc">Mean</span><span class="hl std">=</span><span class="hl kwd">mean</span><span class="hl std">(is_val</span><span class="hl opt">$</span><span class="hl std">cellcount),</span><span class="hl kwc">Var</span><span class="hl std">=</span><span class="hl kwd">var</span><span class="hl std">(is_val</span><span class="hl opt">$</span><span class="hl std">cellcount))</span>
  <span class="hl std">mean</span><span class="hl kwb">=</span><span class="hl kwd">c</span><span class="hl std">(mean,indic_values</span><span class="hl opt">$</span><span class="hl std">Mean)</span>
  <span class="hl std">var</span><span class="hl kwb">=</span><span class="hl kwd">c</span><span class="hl std">(var,indic_values</span><span class="hl opt">$</span><span class="hl std">Var)</span>

  <span class="hl com">## **2) Contamination during cell sorting**  </span>

  <span class="hl com"># Change into a count table format (wide format) with a row per IS.</span>
  <span class="hl std">data_wide</span> <span class="hl kwb">=</span> <span class="hl std">bias1</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">group_by</span><span class="hl std">(posid)</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">count</span><span class="hl std">(celltype)</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">spread</span><span class="hl std">(celltype,n)</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">replace_na</span><span class="hl std">(</span><span class="hl kwd">list</span><span class="hl std">(</span><span class="hl kwc">Bcells</span>  <span class="hl std">=</span> <span class="hl num">0</span><span class="hl std">,</span> <span class="hl kwc">Granulocytes</span> <span class="hl std">=</span> <span class="hl num">0</span><span class="hl std">,</span> <span class="hl kwc">Monocytes</span> <span class="hl std">=</span> <span class="hl num">0</span><span class="hl std">,</span> <span class="hl kwc">NKcells</span> <span class="hl std">=</span><span class="hl num">0</span><span class="hl std">,</span> <span class="hl kwc">Tcells</span> <span class="hl std">=</span> <span class="hl num">0</span><span class="hl std">))</span>

  <span class="hl com">#Get the contamination proportion</span>
  <span class="hl std">obs_conta</span> <span class="hl kwb">=</span> <span class="hl kwd">matrix</span><span class="hl std">(</span><span class="hl num">0</span><span class="hl std">,</span><span class="hl kwc">nrow</span><span class="hl std">=</span><span class="hl kwd">nrow</span><span class="hl std">(data_wide),</span><span class="hl kwc">ncol</span><span class="hl std">=</span><span class="hl num">5</span><span class="hl std">)</span>
  <span class="hl kwd">names</span><span class="hl std">(obs_conta)</span> <span class="hl kwb">=</span> <span class="hl std">cells</span>
  <span class="hl kwa">for</span> <span class="hl std">(x</span> <span class="hl kwa">in</span> <span class="hl num">1</span><span class="hl opt">:</span><span class="hl num">5</span><span class="hl std">){</span>
    <span class="hl com">#select the cell type and put a filter on it</span>
    <span class="hl std">cell</span><span class="hl kwb">=</span><span class="hl std">cells[x]</span>
    <span class="hl com">#select the contamination % of this cell type</span>
    <span class="hl std">conta_prob</span><span class="hl kwb">=</span><span class="hl std">conta_prop[,x]</span>
    <span class="hl std">data_cell</span> <span class="hl kwb">=</span> <span class="hl std">data_wide</span> <span class="hl opt">%&gt;%</span> <span class="hl std">dplyr</span><span class="hl opt">::</span><span class="hl kwd">select</span><span class="hl std">(posid,</span><span class="hl opt">!!</span><span class="hl std">cell)</span>
    <span class="hl com">#apply the contamination</span>
    <span class="hl std">obs_conta</span> <span class="hl kwb">=</span> <span class="hl std">obs_conta</span> <span class="hl opt">+</span> <span class="hl kwd">t</span><span class="hl std">(</span><span class="hl kwd">sapply</span><span class="hl std">(</span><span class="hl kwd">pull</span><span class="hl std">(data_cell,cell),rmultinom,</span><span class="hl kwc">n</span><span class="hl std">=</span><span class="hl num">1</span><span class="hl std">,</span><span class="hl kwc">prob</span><span class="hl std">=conta_prob))</span>
  <span class="hl std">}</span>

  <span class="hl com">#Add the contaminated values (&quot;the cells in the tube&quot;) next to the original values</span>
  <span class="hl std">data_wide</span><span class="hl opt">$</span><span class="hl std">Bcells_cont</span> <span class="hl kwb">=</span> <span class="hl std">obs_conta[,</span><span class="hl num">1</span><span class="hl std">]</span>
  <span class="hl std">data_wide</span><span class="hl opt">$</span><span class="hl std">Monocytes_cont</span> <span class="hl kwb">=</span> <span class="hl std">obs_conta[,</span><span class="hl num">2</span><span class="hl std">]</span>
  <span class="hl std">data_wide</span><span class="hl opt">$</span><span class="hl std">Granulocytes_cont</span> <span class="hl kwb">=</span> <span class="hl std">obs_conta[,</span><span class="hl num">3</span><span class="hl std">]</span>
  <span class="hl std">data_wide</span><span class="hl opt">$</span><span class="hl std">NKcells_cont</span> <span class="hl kwb">=</span> <span class="hl std">obs_conta[,</span><span class="hl num">4</span><span class="hl std">]</span>
  <span class="hl std">data_wide</span><span class="hl opt">$</span><span class="hl std">Tcells_cont</span> <span class="hl kwb">=</span> <span class="hl std">obs_conta[,</span><span class="hl num">5</span><span class="hl std">]</span>
  <span class="hl std">data_wide</span><span class="hl opt">$</span><span class="hl std">cellcount_cont</span> <span class="hl kwb">=</span> <span class="hl kwd">rowSums</span><span class="hl std">(obs_conta)</span>

  <span class="hl com">#Change into a &quot;long-format&quot; : 1 row per cell.</span>
  <span class="hl com">#We now consider the &quot;tube&quot; cells instead of the original cells.</span>
  <span class="hl std">data_B</span><span class="hl kwb">=</span><span class="hl std">data_wide</span>  <span class="hl opt">%&gt;%</span> <span class="hl std">dplyr</span><span class="hl opt">::</span><span class="hl kwd">select</span><span class="hl std">(posid,Bcells_cont)</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">uncount</span><span class="hl std">(Bcells_cont)</span>  <span class="hl opt">%&gt;%</span> <span class="hl kwd">mutate</span><span class="hl std">(</span><span class="hl kwc">tube</span><span class="hl std">=</span><span class="hl str">'Bcells'</span><span class="hl std">)</span>
  <span class="hl std">data_M</span><span class="hl kwb">=</span><span class="hl std">data_wide</span>  <span class="hl opt">%&gt;%</span> <span class="hl std">dplyr</span><span class="hl opt">::</span><span class="hl kwd">select</span><span class="hl std">(posid,Monocytes_cont)</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">uncount</span><span class="hl std">(Monocytes_cont)</span>  <span class="hl opt">%&gt;%</span> <span class="hl kwd">mutate</span><span class="hl std">(</span><span class="hl kwc">tube</span><span class="hl std">=</span><span class="hl str">'Monocytes'</span><span class="hl std">)</span>
  <span class="hl std">data_G</span><span class="hl kwb">=</span><span class="hl std">data_wide</span>  <span class="hl opt">%&gt;%</span> <span class="hl std">dplyr</span><span class="hl opt">::</span><span class="hl kwd">select</span><span class="hl std">(posid,Granulocytes_cont)</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">uncount</span><span class="hl std">(Granulocytes_cont)</span>  <span class="hl opt">%&gt;%</span> <span class="hl kwd">mutate</span><span class="hl std">(</span><span class="hl kwc">tube</span><span class="hl std">=</span><span class="hl str">'Granulocytes'</span><span class="hl std">)</span>
  <span class="hl std">data_K</span><span class="hl kwb">=</span><span class="hl std">data_wide</span>  <span class="hl opt">%&gt;%</span> <span class="hl std">dplyr</span><span class="hl opt">::</span><span class="hl kwd">select</span><span class="hl std">(posid,NKcells_cont)</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">uncount</span><span class="hl std">(NKcells_cont)</span>  <span class="hl opt">%&gt;%</span> <span class="hl kwd">mutate</span><span class="hl std">(</span><span class="hl kwc">tube</span><span class="hl std">=</span><span class="hl str">'NKcells'</span><span class="hl std">)</span>
  <span class="hl std">data_T</span><span class="hl kwb">=</span><span class="hl std">data_wide</span>  <span class="hl opt">%&gt;%</span> <span class="hl std">dplyr</span><span class="hl opt">::</span><span class="hl kwd">select</span><span class="hl std">(posid,Tcells_cont)</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">uncount</span><span class="hl std">(Tcells_cont)</span>  <span class="hl opt">%&gt;%</span> <span class="hl kwd">mutate</span><span class="hl std">(</span><span class="hl kwc">tube</span><span class="hl std">=</span><span class="hl str">'Tcells'</span><span class="hl std">)</span>

  <span class="hl std">bias2</span> <span class="hl kwb">=</span> <span class="hl kwd">bind_rows</span><span class="hl std">(data_B,data_M,data_G,data_K,data_T)</span>
  <span class="hl kwd">rm</span><span class="hl std">(data_B,data_M,data_G,data_K,data_T,obs_conta)</span>

  <span class="hl com">#Calcul of differents indicators on this dataset.</span>
  <span class="hl std">is_val</span><span class="hl kwb">=</span><span class="hl std">bias2</span> <span class="hl opt">%&gt;%</span> <span class="hl std">dplyr</span><span class="hl opt">::</span><span class="hl kwd">select</span><span class="hl std">(tube,posid)</span>  <span class="hl opt">%&gt;%</span> <span class="hl kwd">group_by</span><span class="hl std">(posid)</span> <span class="hl opt">%&gt;%</span> <span class="hl std">dplyr</span><span class="hl opt">::</span><span class="hl kwd">summarise</span><span class="hl std">(</span><span class="hl kwc">cellcount</span><span class="hl std">=</span><span class="hl kwd">n</span><span class="hl std">())</span>
  <span class="hl std">indic_values</span><span class="hl kwb">=</span><span class="hl kwd">data.frame</span><span class="hl std">(</span><span class="hl kwc">NBofIS</span><span class="hl std">=</span><span class="hl kwd">nrow</span><span class="hl std">(is_val),</span><span class="hl kwc">Mean</span><span class="hl std">=</span><span class="hl kwd">mean</span><span class="hl std">(is_val</span><span class="hl opt">$</span><span class="hl std">cellcount),</span><span class="hl kwc">Var</span><span class="hl std">=</span><span class="hl kwd">var</span><span class="hl std">(is_val</span><span class="hl opt">$</span><span class="hl std">cellcount))</span>
  <span class="hl std">mean</span><span class="hl kwb">=</span><span class="hl kwd">c</span><span class="hl std">(mean,indic_values</span><span class="hl opt">$</span><span class="hl std">Mean)</span>
  <span class="hl std">var</span><span class="hl kwb">=</span><span class="hl kwd">c</span><span class="hl std">(var,indic_values</span><span class="hl opt">$</span><span class="hl std">Var)</span>

  <span class="hl com">## **3) Unbalanced sampling**</span>

  <span class="hl std">DNA_freq</span><span class="hl kwb">=</span><span class="hl std">(DNA</span><span class="hl opt">/</span><span class="hl num">0.0066</span><span class="hl std">)</span><span class="hl opt">*</span><span class="hl std">VCN</span>
  <span class="hl std">DNA_freq</span><span class="hl kwb">=</span><span class="hl std">DNA_freq</span><span class="hl opt">/</span><span class="hl kwd">sum</span><span class="hl std">(DNA_freq)</span>

  <span class="hl com">#Get the frequency of each cell type.</span>
  <span class="hl std">prop2</span><span class="hl kwb">=</span><span class="hl std">bias2</span> <span class="hl opt">%&gt;%</span> <span class="hl std">dplyr</span><span class="hl opt">::</span><span class="hl kwd">select</span><span class="hl std">(tube,posid)</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">group_by</span><span class="hl std">(tube)</span> <span class="hl opt">%&gt;%</span>
    <span class="hl std">dplyr</span><span class="hl opt">::</span><span class="hl kwd">summarise</span><span class="hl std">(</span><span class="hl kwc">n</span><span class="hl std">=</span><span class="hl kwd">n</span><span class="hl std">())</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">mutate</span><span class="hl std">(</span><span class="hl kwc">freq</span><span class="hl std">=n</span><span class="hl opt">/</span><span class="hl kwd">sum</span><span class="hl std">(n))</span>  <span class="hl opt">%&gt;%</span> <span class="hl kwd">slice</span><span class="hl std">(</span><span class="hl kwd">match</span><span class="hl std">(tube, cells))</span>
  <span class="hl kwd">colnames</span><span class="hl std">(prop2)</span><span class="hl kwb">=</span><span class="hl kwd">c</span><span class="hl std">(</span><span class="hl str">&quot;tube&quot;</span><span class="hl std">,</span><span class="hl str">'n'</span><span class="hl std">,</span><span class="hl str">'freq'</span><span class="hl std">)</span>
  <span class="hl std">prop2</span><span class="hl kwb">=</span> <span class="hl std">prop2</span> <span class="hl opt">%&gt;%</span>
    <span class="hl kwd">slice</span><span class="hl std">(</span><span class="hl kwd">match</span><span class="hl std">(tube, cells))</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">mutate</span><span class="hl std">(</span><span class="hl kwc">expected</span><span class="hl std">=</span><span class="hl kwd">diag</span><span class="hl std">(DNA_freq))</span>

  <span class="hl com">#Get the smaller cell type.</span>
  <span class="hl std">chosen_one</span><span class="hl kwb">=</span><span class="hl std">prop2[</span><span class="hl kwd">which.min</span><span class="hl std">(prop2</span><span class="hl opt">$</span><span class="hl std">freq),]</span>
  <span class="hl com">#Estimate the nb of cells to take.</span>
  <span class="hl std">nbcells</span><span class="hl kwb">=</span><span class="hl kwd">round</span><span class="hl std">(chosen_one</span><span class="hl opt">$</span><span class="hl std">n</span><span class="hl opt">/</span><span class="hl std">chosen_one</span><span class="hl opt">$</span><span class="hl std">expected)</span>
  <span class="hl std">prop2</span><span class="hl opt">$</span><span class="hl std">nb_to_select</span><span class="hl kwb">=</span><span class="hl kwd">round</span><span class="hl std">(prop2</span><span class="hl opt">$</span><span class="hl std">expected</span><span class="hl opt">*</span><span class="hl std">nbcells)</span>

  <span class="hl com">#Adjust the quantity of cells.</span>
  <span class="hl std">bias3</span><span class="hl kwb">=</span><span class="hl kwd">do.call</span><span class="hl std">(rbind,</span><span class="hl kwd">lapply</span><span class="hl std">(</span><span class="hl num">1</span><span class="hl opt">:</span><span class="hl num">5</span><span class="hl std">,</span><span class="hl kwa">function</span><span class="hl std">(</span><span class="hl kwc">x</span><span class="hl std">){</span>
    <span class="hl std">cell</span><span class="hl kwb">=</span><span class="hl std">cells[x]</span>
    <span class="hl std">data_filter</span><span class="hl kwb">=</span><span class="hl kwd">filter</span><span class="hl std">(bias2,tube</span><span class="hl opt">==</span><span class="hl std">cell)</span>
    <span class="hl com">#select a certain frequency</span>
    <span class="hl std">freq</span><span class="hl kwb">=</span><span class="hl kwd">filter</span><span class="hl std">(prop2,tube</span><span class="hl opt">==</span><span class="hl std">cell)</span>
    <span class="hl std">freq</span><span class="hl kwb">=</span><span class="hl std">freq</span><span class="hl opt">$</span><span class="hl std">nb_to_select</span>
    <span class="hl std">data_filtered</span><span class="hl kwb">=</span> <span class="hl std">data_filter</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">ungroup</span><span class="hl std">()</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">sample_n</span><span class="hl std">(</span><span class="hl kwd">round</span><span class="hl std">(freq))</span>
  <span class="hl std">}))</span>


  <span class="hl com">#Calcul of differents indicators on this dataset.</span>
  <span class="hl std">is_val</span><span class="hl kwb">=</span> <span class="hl std">bias3</span> <span class="hl opt">%&gt;%</span> <span class="hl std">dplyr</span><span class="hl opt">::</span><span class="hl kwd">select</span><span class="hl std">(tube,posid)</span>  <span class="hl opt">%&gt;%</span> <span class="hl kwd">group_by</span><span class="hl std">(posid)</span> <span class="hl opt">%&gt;%</span> <span class="hl std">dplyr</span><span class="hl opt">::</span><span class="hl kwd">summarise</span><span class="hl std">(</span><span class="hl kwc">cellcount</span><span class="hl std">=</span><span class="hl kwd">n</span><span class="hl std">())</span>
  <span class="hl std">indic_values</span><span class="hl kwb">=</span><span class="hl kwd">data.frame</span><span class="hl std">(</span><span class="hl kwc">NBofIS</span><span class="hl std">=</span><span class="hl kwd">nrow</span><span class="hl std">(is_val),</span><span class="hl kwc">Mean</span><span class="hl std">=</span><span class="hl kwd">mean</span><span class="hl std">(is_val</span><span class="hl opt">$</span><span class="hl std">cellcount),</span><span class="hl kwc">Var</span><span class="hl std">=</span><span class="hl kwd">var</span><span class="hl std">(is_val</span><span class="hl opt">$</span><span class="hl std">cellcount))</span>
  <span class="hl std">mean</span><span class="hl kwb">=</span><span class="hl kwd">c</span><span class="hl std">(mean,indic_values</span><span class="hl opt">$</span><span class="hl std">Mean)</span>
  <span class="hl std">var</span><span class="hl kwb">=</span><span class="hl kwd">c</span><span class="hl std">(var,indic_values</span><span class="hl opt">$</span><span class="hl std">Var)</span>

  <span class="hl std">pdataset</span><span class="hl kwb">=</span><span class="hl kwd">colSums</span><span class="hl std">(intSites_new_concat_sup0[,cells])</span><span class="hl opt">/</span><span class="hl kwd">sum</span><span class="hl std">(intSites_new_concat_sup0[,</span><span class="hl str">'cellCount'</span><span class="hl std">])</span>

  <span class="hl com">## Go back to a wide format (a row per IS).</span>
  <span class="hl std">liste_sampled</span> <span class="hl kwb">=</span> <span class="hl kwd">mutate</span><span class="hl std">(bias3,</span> <span class="hl kwc">posid</span> <span class="hl std">=</span> <span class="hl kwd">as.numeric</span><span class="hl std">(posid))</span>
  <span class="hl std">sampled</span> <span class="hl kwb">=</span> <span class="hl std">liste_sampled</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">group_by</span><span class="hl std">(posid,tube)</span> <span class="hl opt">%&gt;%</span> <span class="hl std">dplyr</span><span class="hl opt">::</span><span class="hl kwd">summarise</span><span class="hl std">(</span><span class="hl kwc">nombre</span> <span class="hl std">=</span> <span class="hl kwd">n</span><span class="hl std">())</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">as.data.frame</span><span class="hl std">()</span>
  <span class="hl std">data_sim</span> <span class="hl kwb">=</span> <span class="hl std">sampled</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">spread</span><span class="hl std">(tube,nombre)</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">arrange</span><span class="hl std">(posid)</span>
  <span class="hl std">data_sim[</span><span class="hl kwd">is.na</span><span class="hl std">(data_sim)]</span> <span class="hl kwb">&lt;-</span> <span class="hl num">0</span>
  <span class="hl std">data_sim</span><span class="hl opt">$</span><span class="hl std">cellCount</span> <span class="hl kwb">=</span> <span class="hl kwd">rowSums</span><span class="hl std">(data_sim[,</span><span class="hl num">2</span><span class="hl opt">:</span><span class="hl num">6</span><span class="hl std">])</span>
  <span class="hl std">data_sim</span><span class="hl kwb">=</span><span class="hl kwd">left_join</span><span class="hl std">(data_sim,pop_df[,</span><span class="hl kwd">c</span><span class="hl std">(</span><span class="hl str">'posid'</span><span class="hl std">,</span><span class="hl str">'type'</span><span class="hl std">,</span><span class="hl str">'gene'</span><span class="hl std">)])</span>
  <span class="hl std">data_sim</span><span class="hl kwb">=</span> <span class="hl std">dplyr</span><span class="hl opt">::</span><span class="hl kwd">select</span><span class="hl std">(data_sim,posid,gene,Bcells,Monocytes,Granulocytes,NKcells,Tcells,cellCount,type)</span>
  <span class="hl com">## data_sim is the dataset representing the real Initial data with the different errors introduced during the procedure.</span>

  <span class="hl kwd">return</span><span class="hl std">(</span><span class="hl kwd">list</span><span class="hl std">(</span><span class="hl kwc">pop_df</span><span class="hl std">=pop_df,</span><span class="hl kwc">data_sim</span><span class="hl std">=data_sim,</span><span class="hl kwc">repart</span><span class="hl std">=</span><span class="hl kwd">cbind</span><span class="hl std">(mean,var)))</span>
<span class="hl std">}</span>
</pre></div>
</div></div>

  <p>The R session information (including the OS info, R version and all
    packages used):</p>

<div class="chunk" id="session-info"><div class="rcode"><div class="source"><pre class="knitr r">    <span class="hl kwd">sessionInfo</span><span class="hl std">()</span>
</pre></div>
<div class="output"><pre class="knitr r">## R version 3.3.3 (2017-03-06)
## Platform: x86_64-apple-darwin13.4.0 (64-bit)
## Running under: OS X Yosemite 10.10.5
## 
## locale:
## [1] fr_FR.UTF-8/fr_FR.UTF-8/fr_FR.UTF-8/C/fr_FR.UTF-8/fr_FR.UTF-8
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] knitr_1.20
## 
## loaded via a namespace (and not attached):
## [1] magrittr_1.5    tools_3.3.3     stringi_1.1.6   highr_0.6       stringr_1.3.0  
## [6] evaluate_0.10.1
</pre></div>
<div class="source"><pre class="knitr r">    <span class="hl kwd">Sys.time</span><span class="hl std">()</span>
</pre></div>
<div class="output"><pre class="knitr r">## [1] &quot;2019-12-03 15:46:25 CET&quot;
</pre></div>
</div></div>


</body>
</html>
